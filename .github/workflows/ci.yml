name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  trojan-source-scan:
    name: Trojan Source Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for hidden Unicode characters
        run: |
          # Scan for bidirectional/hidden Unicode control characters (Trojan Source)
          # Characters: U+202A-U+202E, U+2066-U+2069, U+200B-U+200F, U+FEFF
          echo "Scanning for hidden Unicode control characters..."
          if grep -rPn '[\x{202A}-\x{202E}\x{2066}-\x{2069}\x{200B}-\x{200F}\x{FEFF}]' \
            --include='*.rs' --include='*.ts' --include='*.tsx' --include='*.js' \
            --include='*.jsx' --include='*.json' --include='*.yml' --include='*.yaml' \
            --include='*.md' --include='*.toml' --include='*.html' --include='*.css' \
            --exclude-dir=node_modules --exclude-dir=target --exclude-dir=dist \
            . 2>/dev/null; then
            echo "::error::Found hidden Unicode control characters (potential Trojan Source attack)"
            exit 1
          fi
          echo "âœ“ No hidden Unicode control characters found"

  backend:
    name: Backend (Rust)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run Clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test

  frontend:
    name: Frontend (Node)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm test -- --run --passWithNoTests

      - name: Build
        run: npm run build
